import streamlit as st
import pandas as pd

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="Coach Kung: CS Calculator", page_icon="üèÉ‚Äç‚ôÇÔ∏è")

# --- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° ---
st.title("üèÉ‚Äç‚ôÇÔ∏è Critical Speed Calculator")
st.caption("Designed by Coach Kung | Science-Based Training")
st.markdown("---")

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Sidebar) ---
st.sidebar.header("üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤ & ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö")

student_name = st.sidebar.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡∏¨‡∏≤", "‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏∏‡πâ‡∏á (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)")
test_date = st.sidebar.date_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏™‡∏≠‡∏ö")

st.sidebar.markdown("---")
st.sidebar.subheader("‚è±Ô∏è 1. ‡∏ú‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô (Short Test)")
short_duration_option = st.sidebar.selectbox(
    "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏™ (Short):",
    ("3 ‡∏ô‡∏≤‡∏ó‡∏µ (180 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)", "4 ‡∏ô‡∏≤‡∏ó‡∏µ (240 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)", "5 ‡∏ô‡∏≤‡∏ó‡∏µ (300 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)")
)
# ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
short_sec_map = {"3 ‡∏ô‡∏≤‡∏ó‡∏µ (180 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)": 180, "4 ‡∏ô‡∏≤‡∏ó‡∏µ (240 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)": 240, "5 ‡∏ô‡∏≤‡∏ó‡∏µ (300 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)": 300}
t1 = short_sec_map[short_duration_option]

d1 = st.sidebar.number_input("‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ (‡πÄ‡∏°‡∏ï‡∏£) - Short", min_value=0, value=900, step=10)

st.sidebar.markdown("---")
st.sidebar.subheader("‚è±Ô∏è 2. ‡∏ú‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß (Long Test)")
long_duration_option = st.sidebar.selectbox(
    "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏™ (Long):",
    ("10 ‡∏ô‡∏≤‡∏ó‡∏µ (600 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)", "12 ‡∏ô‡∏≤‡∏ó‡∏µ (720 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)", "15 ‡∏ô‡∏≤‡∏ó‡∏µ (900 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)", "20 ‡∏ô‡∏≤‡∏ó‡∏µ (1200 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)")
)
# ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
long_sec_map = {"10 ‡∏ô‡∏≤‡∏ó‡∏µ (600 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)": 600, "12 ‡∏ô‡∏≤‡∏ó‡∏µ (720 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)": 720, "15 ‡∏ô‡∏≤‡∏ó‡∏µ (900 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)": 900, "20 ‡∏ô‡∏≤‡∏ó‡∏µ (1200 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)": 1200}
t2 = long_sec_map[long_duration_option]

d2 = st.sidebar.number_input("‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ (‡πÄ‡∏°‡∏ï‡∏£) - Long", min_value=0, value=3150, step=10)

# ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
calculate_btn = st.sidebar.button("üöÄ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå")

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ---
def get_pace(speed_ms):
    if speed_ms <= 0: return "-"
    sec_per_km = 1000 / speed_ms
    mins = int(sec_per_km // 60)
    secs = int(sec_per_km % 60)
    return f"{mins}:{secs:02d}"

# --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Main Area) ---
if calculate_btn:
    try:
        # 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì CS ‡πÅ‡∏•‡∏∞ D'
        cs = (d2 - d1) / (t2 - t1)
        dp = d2 - (cs * t2)
        cs_pace = get_pace(cs)

        # 2. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Metrics ‡∏´‡∏•‡∏±‡∏Å
        st.subheader(f"üìä ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: {student_name}")
        st.text(f"‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {test_date}")
        
        col1, col2, col3 = st.columns(3)
        col1.metric("Critical Speed (CS)", f"{cs:.2f} m/s", f"Pace {cs_pace}")
        col2.metric("Anaerobic Capacity (D')", f"{dp:.0f} m", "‡∏ñ‡∏±‡∏á‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á")
        
        runner_type = "Hybrid (‡∏™‡∏°‡∏î‡∏∏‡∏•)"
        if dp < 150: runner_type = "Diesel (Aerobic)"
        elif dp > 250: runner_type = "Turbo (Anaerobic)"
        col3.metric("Runner Type", runner_type)

        st.markdown("---")

        # 3. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÇ‡∏ã‡∏ô‡∏ã‡πâ‡∏≠‡∏°
        st.subheader("üéØ ‡πÇ‡∏ã‡∏ô‡∏ã‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (Training Zones)")
        
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        zones_data = [
            ["Zone 1 Recovery", "< 70%", f"> {get_pace(cs*0.70)}", "‡∏Ñ‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏î / Active Rest"],
            ["Zone 2 Easy", "70-80%", f"{get_pace(cs*0.70)} - {get_pace(cs*0.80)}", "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô Aerobic"],
            ["Zone 3 Steady", "80-90%", f"{get_pace(cs*0.80)} - {get_pace(cs*0.90)}", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏ô‡∏ó‡∏≤‡∏ô / Marathon Pace"],
            ["Zone 4 Threshold", "90-100%", f"{get_pace(cs*0.90)} - {get_pace(cs*1.00)}", "Tempo / ‡∏î‡∏±‡∏ô‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢"],
            ["‚ö†Ô∏è CS Line", "100%", f"üìç {cs_pace}", "‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ (Red Line)"],
            ["Zone 5 VO2max", "100-110%", f"{get_pace(cs*1.00)} - {get_pace(cs*1.10)}", "Interval / ‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à"],
            ["Zone 6 Anaerobic", "> 110%", f"< {get_pace(cs*1.10)}", "Speed / ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î"]
        ]
        
        df_zones = pd.DataFrame(zones_data, columns=["Zone", "Intensity", "Pace Range (min/km)", "Objective"])
        
        # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        st.table(df_zones)
        
        # 4. ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÇ‡∏Ñ‡πâ‡∏ä
        st.info(f"üí° **Coach's Insight:** ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó **{runner_type}** (D' = {dp:.0f}m) \n"
                f"‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏° Pace ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ï‡πâ‡∏ô‡∏°‡∏≤‡∏£‡∏≤‡∏ò‡∏≠‡∏ô ‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏ô **{cs_pace}** ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î")

    except ZeroDivisionError:
        st.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏≤‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô")
else:
    st.info("üëà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå'")